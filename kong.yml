_format_version: "3.0"
_transform: true

services:
  # Backend service - Spring Boot Kotlin API
  - name: backend-service
    url: http://backend:8080
    routes:
      # REST API endpoints (Shelly Gen1 & Gen2)
      - name: api-route
        paths:
          - /api
        strip_path: true
        protocols:
          - http
          - https
      
      # GraphQL endpoint with WebSocket support
      - name: graphql-route
        paths:
          - /graphql
        strip_path: false
        protocols:
          - http
          - https
          - ws
          - wss
    
    plugins:
      # CORS plugin for cross-origin requests
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - OPTIONS
            - PATCH
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - X-Auth-Token
            - Authorization
          exposed_headers:
            - X-Auth-Token
          credentials: true
          max_age: 3600
          preflight_continue: false
      
      # Rate limiting plugin for API protection
      - name: rate-limiting
        config:
          second: null
          minute: 100
          hour: null
          day: null
          month: null
          year: null
          limit_by: consumer
          policy: local
          fault_tolerant: true
          hide_client_headers: false
          redis_ssl: false
          redis_ssl_verify: false
          redis_timeout: 2000
          redis_database: 0

  # Frontend service - Nginx serving Preact app
  - name: frontend-service
    url: http://frontend:80
    routes:
      - name: frontend-route
        paths:
          - /
        strip_path: false
        protocols:
          - http
          - https
